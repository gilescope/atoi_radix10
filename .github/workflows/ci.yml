on: push

name: Continuous integration
permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af  # v1.0.7
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - run: |
          cargo fmt --all -- --check
          cargo build --all-targets --release
          cargo test --release
          cargo clippy -- -D warnings

  wasi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af  # v1.0.7
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: wasm32-wasip1
          components: rustfmt

      - run: |
         cargo install wasm-pack
         RUSTFLAGS='--cfg getrandom_backend="wasm_js"' wasm-pack test --node
  wasm32:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af  # v1.0.7
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: wasm32-unknown-unknown
          components: rustfmt

      - run: |
         cargo install wasm-pack
         RUSTFLAGS='--cfg getrandom_backend="wasm_js"' wasm-pack test --node
  miri:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: ""
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af  # v1.0.7
        with:
          profile: minimal
          toolchain: "nightly"
          override: true
          components: miri

      - run: cargo miri test
  fuzz-unsigned:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af  # v1.0.7
        with:
          profile: minimal
          toolchain: nightly
          override: true

      - uses: actions-rs/cargo@844f36862e911db73fe0815f00a4a2602c279505  # v1.0.3
        with:
          command: install
          args: -f cargo-fuzz
      - run: |
          cargo fuzz run fuzz_u8 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_u16 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_u32 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_u64 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_u128 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_usize -- -max_len=42 -max_total_time=10s

  fuzz-sign:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  #v5.0.0

      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af  # v1.0.7
        with:
          profile: minimal
          toolchain: nightly
          override: true

      - uses: actions-rs/cargo@844f36862e911db73fe0815f00a4a2602c279505  # v1.0.3
        with:
          command: install
          args: -f cargo-fuzz
      - run: |
          cargo fuzz run fuzz_i8 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_i16 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_i32 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_i64 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_i128 -- -max_len=42 -max_total_time=10s
          cargo fuzz run fuzz_isize -- -max_len=42 -max_total_time=10s
