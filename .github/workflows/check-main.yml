name: PR â€“ Ensure main green
on: { pull_request: { types: [opened, synchronize, reopened, ready_for_review] } }

permissions:
  contents: read
  checks: read
  statuses: read

jobs:
  ensure-main-green:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  #v8.0.0
        with:
          script: |
            const {owner, repo} = context.repo, branch = 'main';
            const {data: {sha}} = await github.rest.repos.getCommit({owner, repo, ref: branch});
            const {data: {state}} = await github.rest.repos.getCombinedStatusForRef({owner, repo, ref: sha});
            const checks = await github.paginate(github.rest.checks.listForRef, {owner, repo, ref: sha, filter: 'latest', per_page: 100});
            const bad = checks.filter(c => c.status === 'completed' ? c.conclusion !== 'success' : true).map(c => c.name);
            if (state !== 'success' || bad.length) core.setFailed(`main not green: combined=${state}; checks=${bad.join(', ') || 'ok'}`);
